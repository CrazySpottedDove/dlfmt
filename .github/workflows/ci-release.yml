name: Build, Package and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy README into extension
        if: runner.os != 'Windows'
        run: mkdir -p extension/dlfmt && cp README.md extension/dlfmt/README.md
        shell: bash

      - name: Copy README into extension (Windows)
        if: runner.os == 'Windows'
        run: powershell -Command "mkdir extension\\dlfmt -ErrorAction Ignore; Copy-Item README.md extension\\dlfmt\\README.md -Force"
        shell: pwsh

      - name: Setup vcpkg
        run: |
          git clone --depth=1 https://github.com/microsoft/vcpkg.git vcpkg
          if [ "${{ matrix.os }}" = "windows-latest" ]; then ./vcpkg/bootstrap-vcpkg.bat; else ./vcpkg/bootstrap-vcpkg.sh; fi
        shell: bash

        - name: Install OpenMP (macOS only)
        if: runner.os == 'macOS'
        run: brew install libomp

      - name: Configure CMake
        if: runner.os != 'Windows'
        run: cmake -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake -B build-release -S . -DCMAKE_BUILD_TYPE=Release
        shell: bash

      - name: Configure CMake (Windows)
        if: runner.os == 'Windows'
        run: cmake -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}\\vcpkg\\scripts\\buildsystems\\vcpkg.cmake -B build-win -S . -DCMAKE_BUILD_TYPE=Release
        shell: pwsh

      - name: Build (Linux/macOS)
        if: runner.os != 'Windows'
        run: cmake --build build-release --config Release -- -j$(nproc)
        shell: bash

      - name: Build (Windows)
        if: runner.os == 'Windows'
        run: cmake --build build-win --config Release
        shell: pwsh

      - name: Collect binary and package artifact (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          mkdir -p artifacts
          if [ -f build-release/dlfmt ]; then cp build-release/dlfmt artifacts/; fi
          if [ -f build/dlfmt ]; then cp build/dlfmt artifacts/; fi
          cd artifacts
          zip -r ../dlfmt-${{ matrix.os }}.zip .
        shell: bash

      - name: Collect binary and package artifact (Windows)
        if: runner.os == 'Windows'
        run: |
          New-Item -ItemType Directory -Path artifacts -Force | Out-Null
          if (Test-Path build-win\\dlfmt.exe) { Copy-Item build-win\\dlfmt.exe artifacts\\ }
          Compress-Archive -Path artifacts\\* -DestinationPath dlfmt-${{ matrix.os }}.zip -Force
        shell: pwsh

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dlfmt-${{ matrix.os }}
          path: dlfmt-${{ matrix.os }}.zip

  package:
    name: Package VSIX
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download linux artifact
        uses: actions/download-artifact@v4
        with:
          name: dlfmt-ubuntu-latest
          path: artifacts/linux || artifacts/ubuntu

      - name: Download mac artifact
        uses: actions/download-artifact@v4
        with:
          name: dlfmt-macos-latest
          path: artifacts/macos

      - name: Download windows artifact
        uses: actions/download-artifact@v4
        with:
          name: dlfmt-windows-latest
          path: artifacts/windows

      - name: Prepare extension bin folders
        run: |
          rm -rf extension/dlfmt/bin || true
          mkdir -p extension/dlfmt/bin/linux
          mkdir -p extension/dlfmt/bin/macos
          mkdir -p extension/dlfmt/bin/win32
          # extract Linux
          if [ -f artifacts/linux/dlfmt-ubuntu-latest.zip ]; then unzip -o artifacts/linux/dlfmt-ubuntu-latest.zip -d tmp_linux || true; fi
          if [ -f tmp_linux/dlfmt ]; then cp tmp_linux/dlfmt extension/dlfmt/bin/linux/dlfmt; fi
          # extract mac
          if [ -f artifacts/macos/dlfmt-macos-latest.zip ]; then unzip -o artifacts/macos/dlfmt-macos-latest.zip -d tmp_macos || true; fi
          if [ -f tmp_macos/dlfmt ]; then cp tmp_macos/dlfmt extension/dlfmt/bin/macos/dlfmt; fi
          # extract windows
          if [ -f artifacts/windows/dlfmt-windows-latest.zip ]; then powershell -Command "Expand-Archive -Force -Path 'artifacts/windows/dlfmt-windows-latest.zip' -DestinationPath tmp_windows" || true; fi
          if [ -f tmp_windows/dlfmt.exe ]; then cp tmp_windows/dlfmt.exe extension/dlfmt/bin/win32/dlfmt.exe; fi
        shell: bash

      - name: Ensure README present
        run: cp README.md extension/dlfmt/README.md
        shell: bash

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install vsce
        run: npm install -g vsce
        shell: bash

      - name: Package VSIX
        run: |
          cd extension/dlfmt
          vsce package -o ../../dlfmt-${{ github.ref_name || 'dev' }}.vsix
        shell: bash

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: dlfmt-vsix
          path: dlfmt-${{ github.ref_name || 'dev' }}.vsix

  create_release:
    name: Create Release and upload assets
    needs: [build, package]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download VSIX
        uses: actions/download-artifact@v4
        with:
          name: dlfmt-vsix
          path: release_assets

      - name: Download linux zip
        uses: actions/download-artifact@v4
        with:
          name: dlfmt-ubuntu-latest
          path: release_assets/linux

      - name: Download mac zip
        uses: actions/download-artifact@v4
        with:
          name: dlfmt-macos-latest
          path: release_assets/macos

      - name: Download windows zip
        uses: actions/download-artifact@v4
        with:
          name: dlfmt-windows-latest
          path: release_assets/windows

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          body: Release ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload VSIX to Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release_assets/dlfmt-${{ github.ref_name }}.vsix
          asset_name: dlfmt-${{ github.ref_name }}.vsix
          asset_content_type: application/octet-stream

      - name: Upload linux zip
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release_assets/linux/dlfmt-ubuntu-latest.zip
          asset_name: dlfmt-linux.zip
          asset_content_type: application/zip

      - name: Upload mac zip
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release_assets/macos/dlfmt-macos-latest.zip
          asset_name: dlfmt-macos.zip
          asset_content_type: application/zip

      - name: Upload windows zip
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release_assets/windows/dlfmt-windows-latest.zip
          asset_name: dlfmt-windows.zip
          asset_content_type: application/zip